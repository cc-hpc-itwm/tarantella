#!/usr/bin/env python
import argparse
import logging
import os
import subprocess
import sys

TNT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
LIB_DIR = os.path.join(TNT_DIR, "lib/tarantella")
PYLIB_DIR = os.path.join(TNT_DIR, "lib/tarantella/python")
sys.path.append(LIB_DIR)
sys.path.append(PYLIB_DIR)

import runtime.file_management as file_man
import runtime.logging_config as logging_config
import runtime.platform_config as platform_config
import runtime.environment_config as env_config
from runtime import logger

def parse_args():
  parser = argparse.ArgumentParser()
  multinode_group = parser.add_argument_group('Multi-node execution')
  multinode_group.add_argument("--hostfile",
                      dest = "hostfile",
                      help="Path to the list of nodes (hostnames) on which to execute the code",
                      default = None)
  multinode_group.add_argument("--n-per-node", "--device-per-node",
                    help="Number of devices (i.e., either GPUs or CPUs) to be used per node",
                    dest = "npernode",
                    type = int,
                    default = None)
  singlenode_group = parser.add_argument_group('Single-node execution')
  singlenode_group.add_argument("-n",
                    help="Number of processes to start on the local node",
                    dest = "npernode",
                    type = int,
                    default = None)

  parser.add_argument("--no-gpu",
                    help="Disable GPU usage",
                    dest = "use_gpus",
                    action='store_false',
                    default = True)
  parser.add_argument("--log-all-devices",
                    help="Enable logging on all devices",
                    dest = "log_all",
                    action='store_true',
                    default = False)
  parser.add_argument("--log-dir",
                    help="Logging directory; if specified, it will enable \
logging to files within the Tarantella library",
                    dest = "log_dir",
                    default = None)
  log_levels = ('DEBUG', 'INFO', 'WARNING', 'ERROR')
  parser.add_argument('--log-level', default='INFO', choices=log_levels)
  parser.add_argument('app', nargs='+')
  args = parser.parse_args()

  
  return args

class Tarantella:
  def __init__(self, hostlist, num_gpus_per_node, num_cpus_per_node, command_list,
               log_dir, log_all):
    self.log_level = logging.getLevelName(logger.level)
    self.log_dir = log_dir
    self.log_all = log_all

    self.hostlist = hostlist
    self.command_list = command_list

    self.npernode = num_gpus_per_node
    if self.npernode == 0:
      self.npernode = num_cpus_per_node

    self.nranks = len(hostlist) * self.npernode
    self.hostfile = file_man.HostFile(self.hostlist, self.npernode)
    self.executable_script = self.generate_executable_script()

  def generate_executable_script(self):
    # create execution script
    header = "#!/bin/bash"

    environment = env_config.gen_exports_from_dict(env_config.collect_environment_variables()) + \
                  env_config.gen_exports_from_dict(env_config.collect_tensorflow_variables()) + \
                  env_config.gen_exports_from_dict(env_config.collect_tarantella_variables()) + \
                  env_config.gen_exports_from_dict(env_config.get_logging_variables(self.log_level,
                                                                                    self.log_dir,
                                                                                    self.log_all))

    command = "python %s" % (' '.join(self.command_list))
    return file_man.GPIScriptFile(header, environment, command, dir = os.getcwd())

  def run(self):
    with self.hostfile, self.executable_script:
      command_list = ["gaspi_run", "-n", str(self.nranks),
                      "-m", self.hostfile.name,
                      self.executable_script.name]
      result = subprocess.run(command_list,
                  check = True,
                  stdout=None, stderr=None,)

if __name__ == "__main__":
  args = parse_args()
  logging_config.setup_logging(logger, args.log_level)

  nodes_list = platform_config.generate_nodes_list(args.hostfile)
  num_gpus, num_cpus = platform_config.generate_num_devices_per_node(npernode = args.npernode,
                                                                      use_gpus = args.use_gpus)
  env_config.update_environment_paths(LIB_DIR)

  tarantella = Tarantella(nodes_list, num_gpus, num_cpus, args.app, args.log_dir, args.log_all)
  tarantella.run()